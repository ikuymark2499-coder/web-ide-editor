<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DevStudio Gold - AI Engine Fixed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Inter:wght@400;500;600;700&display=swap');
        :root { --bg: #0d1117; --surface: #161b22; --border: #30363d; --accent: #3b82f6; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: #c9d1d9; margin: 0; overflow: hidden; height: 100vh; }
        .code-font { font-family: 'Fira Code', monospace; }
        .glass { background: rgba(22, 27, 34, 0.8); backdrop-filter: blur(10px); }
        .loader { width: 20px; height: 20px; border: 3px solid #3b82f6; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #30363d; border-radius: 10px; }
    </style>
</head>
<body class="flex flex-col">

    <!-- Navbar -->
    <nav class="h-14 border-b border-[#30363d] flex items-center justify-between px-6 bg-[#161b22] z-50">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center font-bold text-white italic">D</div>
            <span class="font-black text-sm tracking-tight text-white italic">DEVSTUDIO <span class="text-blue-500">GOLD</span></span>
        </div>
        <button onclick="toggleAI()" class="bg-blue-600 hover:bg-blue-500 text-white text-[11px] font-bold px-4 py-2 rounded-full shadow-lg shadow-blue-900/20 transition-all flex items-center gap-2">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
            AI GENERATOR
        </button>
    </nav>

    <!-- Main Workspace -->
    <main class="flex-1 flex overflow-hidden">
        <!-- Explorer -->
        <aside class="w-64 border-r border-[#30363d] p-4 hidden md:block">
            <h2 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-4">Your Projects</h2>
            <div id="explorer-list" class="space-y-1 custom-scroll overflow-y-auto max-h-full">
                <!-- Projects will appear here -->
            </div>
        </aside>

        <!-- Editor Area -->
        <section class="flex-1 flex flex-col bg-[#0d1117] relative">
            <div class="h-10 border-b border-[#30363d] flex items-center px-4 bg-[#161b22]">
                <span id="active-file-label" class="text-xs text-gray-400 font-medium italic">No file open</span>
                <div class="ml-auto flex gap-3">
                    <button onclick="runCode()" class="text-emerald-400 hover:text-emerald-300 text-[11px] font-bold">▶ RUN</button>
                </div>
            </div>
            <textarea id="code-editor" class="flex-1 bg-transparent p-6 text-white code-font text-sm outline-none resize-none" spellcheck="false" placeholder="// Select a file or use AI to generate code..."></textarea>
        </section>
    </main>

    <!-- AI Interface Overlay -->
    <div id="ai-overlay" class="fixed inset-0 z-[100] hidden bg-black/80 backdrop-blur-sm items-center justify-center p-4">
        <div class="bg-[#161b22] border border-[#30363d] w-full max-w-xl rounded-3xl overflow-hidden shadow-2xl flex flex-col max-h-[85vh]">
            <div class="p-4 border-b border-[#30363d] flex items-center justify-between bg-[#0d1117]">
                <span class="text-blue-400 font-bold flex items-center gap-2">✨ AI CORE GENERATOR</span>
                <button onclick="toggleAI()" class="text-gray-500 hover:text-white">✕</button>
            </div>

            <!-- Chat/Prompt Area -->
            <div id="ai-chat-body" class="flex-1 overflow-y-auto p-6 space-y-4 custom-scroll bg-[#0d1117]/50">
                <div class="bg-blue-500/10 border border-blue-500/20 p-4 rounded-2xl text-xs leading-relaxed">
                    <span class="text-blue-400 font-bold block mb-1 uppercase">DevStudio Assistant</span>
                    สวัสดีครับ! ผมเป็น AI ที่จะช่วยคุณเขียนโค้ด เพียงระบุชื่อไฟล์และสิ่งที่คุณต้องการ ผมจะสร้างโค้ดดิบที่พร้อมรันให้ทันที
                </div>
                <div id="chat-messages" class="space-y-4"></div>
            </div>

            <!-- Inputs -->
            <div class="p-6 border-t border-[#30363d] bg-[#161b22] space-y-3">
                <div class="flex gap-2">
                    <input type="text" id="ai-filename" placeholder="ชื่อไฟล์ (เช่น index.html)" class="flex-1 bg-[#0d1117] border border-[#30363d] px-4 py-2 rounded-xl text-xs outline-none focus:border-blue-500 transition-all">
                </div>
                <div class="flex gap-2">
                    <textarea id="ai-prompt" rows="2" placeholder="อธิบายสิ่งที่คุณต้องการสร้าง..." class="flex-1 bg-[#0d1117] border border-[#30363d] p-4 rounded-xl text-sm outline-none focus:border-blue-500 transition-all resize-none"></textarea>
                    <button id="ai-gen-btn" onclick="callAIEngine()" class="bg-blue-600 hover:bg-blue-500 text-white px-6 rounded-xl font-bold flex items-center justify-center transition-all">
                        GEN
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Preview -->
    <div id="preview-screen" class="fixed inset-0 z-[200] bg-white hidden flex-col">
        <div class="h-12 bg-gray-900 flex items-center justify-between px-6">
            <span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Live Output Preview</span>
            <button onclick="closePreview()" class="bg-red-500 hover:bg-red-400 text-white px-4 py-1.5 rounded-full text-[10px] font-bold">CLOSE</button>
        </div>
        <iframe id="preview-frame" class="w-full flex-1 border-none bg-white"></iframe>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-white text-black px-6 py-3 rounded-full font-bold text-xs shadow-2xl transition-all translate-y-20 opacity-0 z-[500]"></div>

    <script>
        const apiKey = ""; // ระบบจะจัดการ API Key ให้โดยอัตโนมัติ

        // Local Storage / Database
        let projects = JSON.parse(localStorage.getItem('ds_projects')) || [];
        let activeFile = null;

        function save() {
            localStorage.setItem('ds_projects', JSON.stringify(projects));
            renderExplorer();
        }

        function toggleAI() {
            const overlay = document.getElementById('ai-overlay');
            overlay.classList.toggle('hidden');
            overlay.classList.toggle('flex');
        }

        function notify(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 3000);
        }

        // --- AI ENGINE (The Fixed Part) ---
        async function callAIEngine() {
            const promptInput = document.getElementById('ai-prompt');
            const filenameInput = document.getElementById('ai-filename');
            const chatMessages = document.getElementById('chat-messages');
            const btn = document.getElementById('ai-gen-btn');

            const prompt = promptInput.value.trim();
            const filename = filenameInput.value.trim();

            if (!prompt || !filename) return notify("กรุณากรอกชื่อไฟล์และคำสั่งครับ");

            // UI Update: Loading
            const msgId = Date.now();
            const aiMsg = document.createElement('div');
            aiMsg.className = "bg-[#161b22] border border-[#30363d] p-4 rounded-2xl text-xs text-gray-400 italic";
            aiMsg.id = `ai-msg-${msgId}`;
            aiMsg.innerHTML = `<span class="loader align-middle mr-2"></span> กำลังสร้างโค้ดสำหรับ ${filename}...`;
            chatMessages.appendChild(aiMsg);
            btn.disabled = true;
            document.getElementById('ai-chat-body').scrollTop = document.getElementById('ai-chat-body').scrollHeight;

            const systemPrompt = `You are a professional software architect.
            Task: Generate ONLY raw source code for a file named "${filename}".
            Constraint: Output the code directly. Do NOT include markdown blocks like \`\`\`html or \`\`\`css. 
            Quality: If it is HTML, use Tailwind CSS CDN for styling. Make it mobile-friendly.`;

            // Function with Exponential Backoff
            async function fetchWithRetry(retries = 5, delay = 1000) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] }
                        })
                    });

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    const data = await response.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!text) throw new Error("No response text from AI");
                    return text;
                } catch (err) {
                    if (retries > 0) {
                        await new Promise(res => setTimeout(res, delay));
                        return fetchWithRetry(retries - 1, delay * 2);
                    }
                    throw err;
                }
            }

            try {
                let generatedCode = await fetchWithRetry();
                
                // Clean up any markdown blocks if the AI ignored instructions
                generatedCode = generatedCode.replace(/^```[a-z]*\n/gi, '').replace(/\n```$/g, '').trim();

                // Store in projects
                const newFile = { name: filename, content: generatedCode, id: msgId };
                projects.push(newFile);
                save();

                aiMsg.innerHTML = `<span class="text-blue-400 font-bold">✅ สำเร็จ!</span> โค้ดถูกสร้างแล้ว และบันทึกเข้าสู่ระบบเรียบร้อย`;
                
                setTimeout(() => {
                    toggleAI();
                    openFile(newFile);
                    notify("สร้างไฟล์สำเร็จ!");
                    promptInput.value = "";
                    filenameInput.value = "";
                    btn.disabled = false;
                }, 1000);

            } catch (error) {
                console.error(error);
                aiMsg.innerHTML = `<span class="text-red-500 font-bold">❌ ผิดพลาด:</span> ไม่สามารถเชื่อมต่อกับ AI ได้ในขณะนี้ โปรดลองกด GEN ใหม่อีกครั้ง`;
                btn.disabled = false;
            }
        }

        // --- Workspace Management ---
        function renderExplorer() {
            const list = document.getElementById('explorer-list');
            list.innerHTML = '';
            projects.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = "flex items-center justify-between p-2 rounded-lg hover:bg-[#1c2128] cursor-pointer group";
                item.innerHTML = `
                    <div class="flex items-center gap-2" onclick="openFileById(${file.id})">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#58a6ff" stroke-width="2"><path d="M13 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V9z"/><path d="M13 2v7h7"/></svg>
                        <span class="text-xs text-gray-300 font-medium">${file.name}</span>
                    </div>
                    <button onclick="deleteFile(${file.id})" class="text-gray-600 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity">✕</button>
                `;
                list.appendChild(item);
            });
        }

        function openFile(file) {
            activeFile = file;
            document.getElementById('active-file-label').textContent = file.name;
            document.getElementById('code-editor').value = file.content;
        }

        function openFileById(id) {
            const file = projects.find(f => f.id === id);
            if(file) openFile(file);
        }

        function deleteFile(id) {
            projects = projects.filter(f => f.id !== id);
            if(activeFile && activeFile.id === id) {
                activeFile = null;
                document.getElementById('code-editor').value = '';
                document.getElementById('active-file-label').textContent = 'No file open';
            }
            save();
        }

        function runCode() {
            const code = document.getElementById('code-editor').value;
            if(!code) return notify("ไม่มีโค้ดให้รัน!");
            
            const frame = document.getElementById('preview-frame');
            const screen = document.getElementById('preview-screen');
            
            const blob = new Blob([code], { type: 'text/html' });
            frame.src = URL.createObjectURL(blob);
            screen.classList.replace('hidden', 'flex');
        }

        function closePreview() {
            document.getElementById('preview-screen').classList.replace('flex', 'hidden');
        }

        // Autosave content when typing
        document.getElementById('code-editor').addEventListener('input', (e) => {
            if(activeFile) {
                const index = projects.findIndex(f => f.id === activeFile.id);
                if(index !== -1) {
                    projects[index].content = e.target.value;
                    localStorage.setItem('ds_projects', JSON.stringify(projects));
                }
            }
        });

        // Initialize
        renderExplorer();
    </script>
</body>
</html>
